import { NextResponse } from 'next/server';

export async function POST(request: Request) {
  try {
    const { type, data } = await request.json();

    const WEBHOOK_URL = process.env.NOTIFICATION_WEBHOOK_URL;

    if (!WEBHOOK_URL) {
      console.log('Notification webhook not configured');
      return NextResponse.json({ success: false, message: 'Webhook not configured' });
    }

    let message = '';
    let color = 0x70d490; // Default green

    switch (type) {
      case 'email_submitted':
        message = `ğŸ‰ New Email Signup!\n\nEmail: ${data.email}\nVoucher: Â£${data.voucherValue}\nCode: ${data.voucherCode}\nTotal Signups: ${data.totalSignups}`;
        color = 0x1f3a33;
        break;

      case 'voucher_claimed':
        message = `âœ… Voucher Claimed!\n\nName: ${data.name}\nEmail: ${data.email}\nPostcode: ${data.postcode}\nVoucher: ${data.voucherCode} (Â£${data.voucherValue})\nDraw Entries: ${data.entries}`;
        color = 0x70d490;
        break;

      case 'survey_4q_completed':
        message = `ğŸ“‹ 4 Questions Completed!\n\nName: ${data.name}\nEmail: ${data.email}\nEntries: 2\nTime to complete: ${data.timeToComplete} minutes`;
        color = 0x70d490;
        break;

      case 'survey_10q_completed':
        message = `âœ… Full Survey Completed!\n\nName: ${data.name}\nEmail: ${data.email}\nEntries: 3\nDevice: ${data.device}\nTotal time: ${data.totalTime} minutes`;
        color = 0xffd700;
        break;

      case 'referral_conversion':
        message = `ğŸ Referral Converted!\n\nReferrer: ${data.referrerName}\nNew signup: ${data.newEmail}\nReferrer now has: ${data.totalReferrals} referrals\nBonus entries: +10 (${data.totalEntries} total)`;
        color = 0xff6b6b;
        break;

      case 'stage_1_email':
        message = `ğŸ“§ Stage 1: Email Submitted\n\nEmail: ${data.email}\nCampaign Source: ${data.campaignSource || 'Unknown'}\nTotal Signups: ${data.totalSignups || '?'}`;
        color = 0x70d490;
        break;

      case 'stage_2_name':
        message = `ğŸ‘¤ Stage 2: Name Added\n\nName: ${data.name}\nEmail: ${data.email}\nCustomer ID: ${data.customerId || '?'}`;
        color = 0x4a90e2;
        break;

      case 'stage_3_phone':
        message = `ğŸ“± Stage 3: Phone & Address Complete\n\nName: ${data.name}\nPhone: ${data.phone}\nAddress: ${data.address || 'N/A'}\nVoucher: ${data.voucherCode} (Â£${data.voucherValue})`;
        color = 0xf39c12;
        break;

      case 'milestone_signups':
        message = `ğŸ¯ **MILESTONE REACHED!**\n\n**${data.totalSignups} Total Signups!**\n\nLatest: ${data.latestName || 'Unknown'}\nSource: ${data.campaignSource || 'Unknown'}\n\nKeep the momentum going! ğŸš€`;
        color = 0xffd700;
        break;

      case 'household_members':
        message = `ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Family Signups Added!\n\nPrimary: ${data.primaryName}\nFamily Members: ${data.householdCount}\nTotal Vouchers: ${data.householdCount + 1}\n\nMembers: ${data.householdNames?.join(', ') || 'Unknown'}`;
        color = 0x3498db;
        break;

      default:
        message = `ğŸ“¢ Event: ${type}\n\nData: ${JSON.stringify(data, null, 2)}`;
    }

    // Send to Discord/Slack webhook format
    const payload = {
      embeds: [{
        title: getTitle(type),
        description: message,
        color: color,
        timestamp: new Date().toISOString(),
        footer: {
          text: 'Smile Moore Dashboard',
        },
      }],
    };

    await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload),
    });

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('Error sending notification:', error);
    return NextResponse.json(
      { error: 'Failed to send notification' },
      { status: 500 }
    );
  }
}

function getTitle(type: string): string {
  const titles: Record<string, string> = {
    'email_submitted': 'ğŸ“§ New Email Signup',
    'voucher_claimed': 'âœ… Voucher Claimed',
    'survey_4q_completed': 'ğŸ“‹ Survey Progress',
    'survey_10q_completed': 'âœ… Full Survey Complete',
    'referral_conversion': 'ğŸ Referral Success',
    'stage_1_email': 'ğŸ“§ Stage 1: Email',
    'stage_2_name': 'ğŸ‘¤ Stage 2: Name',
    'stage_3_phone': 'ğŸ“± Stage 3: Complete',
    'milestone_signups': 'ğŸ¯ MILESTONE!',
    'household_members': 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Family Added',
  };
  return titles[type] || 'ğŸ“¢ System Notification';
}
